package org.folio.inventory.dataimport.handlers.actions;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import io.vertx.core.Future;
import io.vertx.core.Promise;
import io.vertx.core.json.Json;
import io.vertx.core.json.JsonObject;

import java.util.HashMap;

import org.apache.commons.lang3.StringUtils;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.folio.ActionProfile;
import org.folio.DataImportEventPayload;
import org.folio.HoldingsRecord;
import org.folio.MappingProfile;
import org.folio.inventory.common.Context;
import org.folio.inventory.dataimport.cache.MappingMetadataCache;
import org.folio.inventory.dataimport.services.OrderEventService;
import org.folio.inventory.dataimport.util.ParsedRecordUtil;
import org.folio.inventory.domain.HoldingsRecordCollection;
import org.folio.inventory.domain.relationship.RecordToEntity;
import org.folio.inventory.services.IdStorageService;
import org.folio.inventory.storage.Storage;
import org.folio.kafka.exception.DuplicateEventException;
import org.folio.processing.events.services.handler.EventHandler;
import org.folio.processing.exceptions.EventProcessingException;
import org.folio.processing.mapping.MappingManager;
import org.folio.processing.mapping.defaultmapper.processor.parameters.MappingParameters;
import org.folio.processing.mapping.mapper.MappingContext;
import org.folio.rest.jaxrs.model.EntityType;
import org.folio.rest.jaxrs.model.ProfileSnapshotWrapper;
import org.folio.rest.jaxrs.model.Record;

import java.util.UUID;
import java.util.concurrent.CompletableFuture;

import static java.lang.String.format;
import static org.apache.commons.lang.StringUtils.isNotBlank;
import static org.apache.commons.lang3.StringUtils.isBlank;
import static org.apache.commons.lang3.StringUtils.isEmpty;
import static org.apache.logging.log4j.util.Strings.isNotEmpty;
import static org.folio.ActionProfile.FolioRecord.HOLDINGS;
import static org.folio.ActionProfile.FolioRecord.MARC_BIBLIOGRAPHIC;
import static org.folio.DataImportEventTypes.DI_INVENTORY_HOLDING_CREATED;
import static org.folio.inventory.dataimport.handlers.matching.util.EventHandlingUtil.constructContext;
import static org.folio.inventory.dataimport.util.DataImportConstants.UNIQUE_ID_ERROR_MESSAGE;
import static org.folio.rest.jaxrs.model.ProfileSnapshotWrapper.ContentType.ACTION_PROFILE;
import static org.folio.rest.jaxrs.model.ProfileSnapshotWrapper.ContentType.MAPPING_PROFILE;

public class CreateHoldingEventHandler implements EventHandler {

  private static final Logger LOGGER = LogManager.getLogger(CreateHoldingEventHandler.class);
  private static final String INSTANCE_ID_FIELD = "instanceId";
  private static final String RECORD_ID_HEADER = "recordId";
  private static final String CHUNK_ID_HEADER = "chunkId";
  private static final String HOLDINGS_PATH_FIELD = "holdings";
  private static final String PERMANENT_LOCATION_ID_FIELD = "permanentLocationId";
  private static final String PERMANENT_LOCATION_ID_ERROR_MESSAGE = "Can`t create Holding entity: 'permanentLocationId' is empty";
  private static final String CREATE_HOLDING_ERROR_MESSAGE = "Failed to create Holdings";
  private static final String CONTEXT_EMPTY_ERROR_MESSAGE = "Can`t create Holding entity: context is empty or doesn`t exists";
  private static final String PAYLOAD_DATA_HAS_NO_INSTANCE_ID_ERROR_MSG = "Failed to extract instanceId from instance entity or parsed record";
  private static final String MAPPING_METADATA_NOT_FOUND_MSG = "MappingMetadata snapshot was not found by jobExecutionId '%s'. RecordId: '%s', chunkId: '%s' ";
  static final String ACTION_HAS_NO_MAPPING_MSG = "Action profile to create a Holding entity requires a mapping profile";
  private static final String FOLIO_SOURCE_ID = "f32d531e-df79-46b3-8932-cdd35f7a2264";

  //private static final String ORDER_JOB_PROFILE = "{\"id\":\"bf002fb4-1666-47fa-8321-5417cfd77cfa\",\"profileId\":\"fa45f3ec-9b83-11eb-a8b3-0242ac130003\",\"contentType\":\"ACTION_PROFILE\",\"content\":{\"id\":\"fa45f3ec-9b83-11eb-a8b3-0242ac130003\",\"name\":\"Create order\",\"action\":\"CREATE\",\"hidden\":false,\"deleted\":false,\"metadata\":{\"createdDate\":\"2021-04-13T14:00:00.000+00:00\",\"updatedDate\":\"2021-04-13T15:00:00.462+00:00\",\"createdByUserId\":\"00000000-0000-0000-0000-000000000000\",\"updatedByUserId\":\"00000000-0000-0000-0000-000000000000\"},\"userInfo\":{\"lastName\":\"System\",\"userName\":\"System\",\"firstName\":\"System\"},\"description\":\"This action profile is used with FOLIO's default job profile for creating Inventory Instances and SRS MARC Bibliographic records. It can be edited, duplicated, or deleted.\",\"folioRecord\":\"Order\",\"childProfiles\":[],\"parentProfiles\":[]},\"order\":0,\"childSnapshotWrappers\":[{\"id\":\"244f2c39-ad7a-4046-8a51-2fdd46d3572f\",\"name\":\"Testing Orders+OrderLines\",\"description\":\"\",\"incomingRecordType\":\"MARC_BIBLIOGRAPHIC\",\"existingRecordType\":\"ORDER\",\"deleted\":false,\"userInfo\":{\"firstName\":\"DIKU\",\"lastName\":\"ADMINISTRATOR\",\"userName\":\"diku_admin\"},\"marcFieldProtectionSettings\":[],\"parentProfiles\":[],\"childProfiles\":[],\"mappingDetails\":{\"name\":\"order\",\"recordType\":\"ORDER\",\"mappingFields\":[{\"name\":\"poStatus\",\"enabled\":\"true\",\"path\":\"order.po.poStatus\",\"value\":\"\\\"Pending\\\"\",\"subfields\":[]},{\"name\":\"approved\",\"enabled\":\"true\",\"path\":\"order.po.approved\",\"booleanFieldAction\":\"ALL_TRUE\",\"subfields\":[]},{\"name\":\"poLinesLimit\",\"enabled\":\"false\",\"path\":\"order.po.poLinesLimit\",\"subfields\":[]},{\"name\":\"overridePoLinesLimit\",\"enabled\":\"true\",\"path\":\"order.po.overridePoLinesLimit\",\"subfields\":[]},{\"name\":\"prefix\",\"enabled\":\"true\",\"path\":\"order.po.poNumberPrefix\",\"value\":\"\\\"pref\\\"\",\"subfields\":[],\"acceptedValues\":{\"db9f5d17-0ca3-4d14-ae49-16b63c8fc083\":\"pref\"}},{\"name\":\"poNumber\",\"enabled\":\"true\",\"path\":\"order.po.poNumber\",\"value\":\"\",\"subfields\":[]},{\"name\":\"suffix\",\"enabled\":\"true\",\"path\":\"order.po.poNumberSuffix\",\"value\":\"\\\"suf\\\"\",\"subfields\":[],\"acceptedValues\":{\"0c966bd2-0ca6-43a2-9388-3a4403f19e6f\":\"suf\"}},{\"name\":\"vendor\",\"enabled\":\"true\",\"path\":\"order.po.vendor\",\"value\":\"\\\"11fb627a-cdf1-11e8-a8d5-f2801f1b9fd1\\\"\",\"subfields\":[]},{\"name\":\"orderType\",\"enabled\":\"true\",\"path\":\"order.po.orderType\",\"value\":\"\\\"One-time\\\"\",\"subfields\":[]},{\"name\":\"acqUnitIds\",\"enabled\":\"true\",\"path\":\"order.po.acqUnitIds[]\",\"value\":\"\\\"main\\\"\",\"subfields\":[],\"acceptedValues\":{\"0ebb1f7d-983f-3026-8a4c-5318e0ebc041\":\"main\"}},{\"name\":\"assignedTo\",\"enabled\":\"true\",\"path\":\"order.po.assignedTo\",\"value\":\"\",\"subfields\":[]},{\"name\":\"billTo\",\"enabled\":\"true\",\"path\":\"order.po.billTo\",\"value\":\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"billToAddress\",\"enabled\":\"false\",\"path\":\"order.po.billToAddress\",\"value\":\"\",\"subfields\":[]},{\"name\":\"shipTo\",\"enabled\":\"true\",\"path\":\"order.po.shipTo\",\"value\":\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"shipToAddress\",\"enabled\":\"false\",\"path\":\"order.po.shipToAddress\",\"value\":\"\",\"subfields\":[]},{\"name\":\"manualPo\",\"enabled\":\"true\",\"path\":\"order.po.manualPo\",\"booleanFieldAction\":\"ALL_TRUE\",\"subfields\":[]},{\"name\":\"reEncumber\",\"enabled\":\"true\",\"path\":\"order.po.reEncumber\",\"value\":\"\\\"true\\\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"notes\",\"enabled\":\"true\",\"path\":\"order.po.notes[]\",\"value\":\"\",\"subfields\":[{\"order\":0,\"path\":\"order.po.notes[]\",\"fields\":[{\"name\":\"notes\",\"enabled\":\"true\",\"path\":\"order.po.notes[]\",\"value\":\"\\\"TestingNote\\\"\",\"subfields\":[]}]}]},{\"name\":\"title\",\"enabled\":\"true\",\"path\":\"order.poLine.title.title\",\"value\":\"\\\"TestingTitle\\\"\",\"subfields\":[]},{\"name\":\"receivingNote\",\"enabled\":\"true\",\"path\":\"order.poLine.title.receivingNote\",\"value\":\"\\\"TestingReceivingNote\\\"\",\"subfields\":[]},{\"name\":\"isAcknowledged\",\"enabled\":\"true\",\"path\":\"order.poLine.title.isAcknowledged\",\"value\":\"\\\"true\\\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"subscriptionFrom\",\"enabled\":\"true\",\"path\":\"order.poLine.details.subscriptionFrom\",\"value\":\"###TODAY###\",\"subfields\":[]},{\"name\":\"subscriptionTo\",\"enabled\":\"true\",\"path\":\"order.poLine.details.subscriptionTo\",\"value\":\"###TODAY###\",\"subfields\":[]},{\"name\":\"subscriptionInterval\",\"enabled\":\"true\",\"path\":\"order.poLine.details.subscriptionInterval\",\"value\":\"\\\"1\\\"\",\"subfields\":[]},{\"name\":\"publicationDate\",\"enabled\":\"true\",\"path\":\"order.poLine.publicationDate\",\"value\":\"\",\"subfields\":[]},{\"name\":\"publisher\",\"enabled\":\"true\",\"path\":\"order.poLine.publisher\",\"value\":\"\",\"subfields\":[]},{\"name\":\"edition\",\"enabled\":\"true\",\"path\":\"order.poLine.edition\",\"value\":\"\",\"subfields\":[]},{\"name\":\"contributors\",\"enabled\":\"true\",\"path\":\"order.poLine.contributors[]\",\"value\":\"\",\"subfields\":[{\"order\":0,\"path\":\"order.poLine.contributors[]\",\"fields\":[{\"name\":\"contributor\",\"enabled\":\"true\",\"path\":\"order.poLine.contributors[].contributor\",\"value\":\"\\\"Test Contributor\\\"\",\"subfields\":[]},{\"name\":\"contributorNameTypeId\",\"enabled\":\"true\",\"path\":\"order.poLine.contributors[].contributorNameTypeId\",\"value\":\"\\\"Personal name\\\"\",\"subfields\":[]}]}]},{\"name\":\"productIds\",\"enabled\":\"true\",\"path\":\"order.poLine.details.productIds[]\",\"value\":\"\",\"subfields\":[{\"order\":0,\"path\":\"order.poLine.details.productIds[]\",\"fields\":[{\"name\":\"productId\",\"enabled\":\"true\",\"path\":\"order.poLine.details.productIds[].productId\",\"value\":\"\",\"subfields\":[]},{\"name\":\"qualifier\",\"enabled\":\"true\",\"path\":\"order.poLine.details.productIds[].qualifier\",\"value\":\"\",\"subfields\":[]},{\"name\":\"productIdType\",\"enabled\":\"true\",\"path\":\"order.poLine.details.productIds[].productIdType\",\"value\":\"\\\"DOI\\\"\",\"subfields\":[],\"acceptedValues\":{\"1795ea23-6856-48a5-a772-f356e16a8a6c\":\"UPC\",\"b3ea81fb-3324-4c64-9efc-7c0c93d5943c\":\"Invalid UPC\",\"4f07ea37-6c7f-4836-add2-14249e628ed1\":\"Invalid ISMN\",\"c858e4f2-2b6b-4385-842b-60732ee14abb\":\"LCCN\",\"b5d8cdc4-9441-487c-90cf-0c7ec97728eb\":\"Publisher or distributor number\",\"fc4e3f2a-887a-46e5-8057-aeeb271a4e56\":\"Cancelled system control number\",\"351ebc1c-3aae-4825-8765-c6d50dbf011f\":\"GPO item number\",\"913300b2-03ed-469a-8179-c1092c991227\":\"ISSN\",\"5d164f4b-0b15-4e42-ae75-cfcf85318ad9\":\"Control number\",\"216b156b-215e-4839-a53e-ade35cb5702a\":\"Handle\",\"37b65e79-0392-450d-adc6-e2a1f47de452\":\"Report number\",\"439bfbae-75bc-4f74-9fc7-b2a2d47ce3ef\":\"OCLC\",\"fcca2643-406a-482a-b760-7a7f8aec640e\":\"Invalid ISBN\",\"593b78cb-32f3-44d1-ba8c-63fd5e6989e6\":\"CODEN\",\"39554f54-d0bb-4f0a-89a4-e422f6136316\":\"DOI\",\"eb7b2717-f149-4fec-81a3-deefb8f5ee6b\":\"URN\",\"5130aed5-1095-4fb6-8f6f-caa3d6cc7aae\":\"Local identifier\",\"27fd35a6-b8f6-41f2-aa0e-9c663ceb250c\":\"Invalid ISSN\",\"650ef996-35e3-48ec-bf3a-a0d078a0ca37\":\"UkMac\",\"3187432f-9434-40a8-8782-35a111a1491e\":\"BNB\",\"3fbacad6-0240-4823-bce8-bb122cfdf229\":\"StEdNL\",\"5069054d-bc3a-4212-a4e8-e2013a02386f\":\"Cancelled GPO item number\",\"5860f255-a27f-4916-a830-262aa900a6b9\":\"Linking ISSN\",\"2e8b3b6c-0e7d-4e48-bca2-b0b23b376af5\":\"Other standard identifier\",\"ebfd00b6-61d3-4d87-a6d8-810c941176d5\":\"ISMN\",\"7f907515-a1bf-4513-8a38-92e1a07c539d\":\"ASIN\",\"8261054f-be78-422d-bd51-4ed9f33c3422\":\"ISBN\",\"7e591197-f335-4afb-bc6d-a6d76ca3bace\":\"System control number\",\"8e3dd25e-db82-4b06-8311-90d41998c109\":\"Standard technical report number\"}}]}]},{\"name\":\"internalNote\",\"enabled\":\"true\",\"path\":\"order.poLine.internalNote\",\"value\":\"\\\"TestingInternalNote\\\"\",\"subfields\":[]},{\"name\":\"poLineNumber\",\"enabled\":\"false\",\"path\":\"order.poLine.poLineNumber\",\"value\":\"\",\"subfields\":[]},{\"name\":\"acquisitionMethod\",\"enabled\":\"true\",\"path\":\"order.poLine.acquisitionMethod\",\"value\":\"\\\"Approval Plan\\\"\",\"subfields\":[],\"acceptedValues\":{\"aaa541f3-39d2-4887-ab8f-6ba12d08ca52\":\"Evidence Based Acquisitions (EBA)\",\"86d12634-b848-4968-adf0-5a95ce41c41b\":\"Free\",\"5771a8a4-9323-49ee-9002-1b068d71ff42\":\"Membership\",\"0c9b09c9-b94f-4702-aa63-a7f43617a225\":\"Internal transfer\",\"796596c4-62b5-4b64-a2ce-524c747afaa2\":\"Approval Plan\",\"306489dd-0053-49ee-a068-c316444a8f55\":\"Purchase At Vendor System\",\"0a4163a5-d225-4007-ad90-2fb41b73efab\":\"Gift\",\"041035ad-b2a4-4aa0-b6a5-234b88bf938c\":\"Demand Driven Acquisitions (DDA)\",\"d2420b93-7b93-41b7-8b42-798f64cb6dd2\":\"Depository\",\"da6703b1-81fe-44af-927a-94f24d1ab8ee\":\"Other\",\"df26d81b-9d63-4ff8-bf41-49bf75cfa70e\":\"Purchase\",\"d0d3811c-19f8-4c57-a462-958165cdbbea\":\"Technical\",\"8a33895e-2c69-4a98-ab48-b7ec1fa852d0\":\"Exchange\"}},{\"name\":\"automaticExport\",\"enabled\":\"true\",\"path\":\"order.poLine.automaticExport\",\"booleanFieldAction\":\"ALL_FALSE\",\"subfields\":[]},{\"name\":\"orderFormat\",\"enabled\":\"true\",\"path\":\"order.poLine.orderFormat\",\"value\":\"\\\"P/E Mix\\\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"createdOn\",\"enabled\":\"false\",\"path\":\"order.poLine.createdOn\",\"value\":\"\",\"subfields\":[]},{\"name\":\"receiptDate\",\"enabled\":\"true\",\"path\":\"order.poLine.receiptDate\",\"value\":\"###TODAY###\",\"subfields\":[]},{\"name\":\"receiptStatus\",\"enabled\":\"true\",\"path\":\"order.poLine.receiptStatus\",\"value\":\"\\\"Pending\\\"\",\"subfields\":[]},{\"name\":\"paymentStatus\",\"enabled\":\"true\",\"path\":\"order.poLine.paymentStatus\",\"value\":\"\\\"Pending\\\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"source\",\"enabled\":\"false\",\"path\":\"order.poLine.source\",\"value\":\"\\\"MARC\\\"\",\"subfields\":[]},{\"name\":\"donor\",\"enabled\":\"true\",\"path\":\"order.poLine.donor\",\"value\":\"\",\"subfields\":[]},{\"name\":\"selector\",\"enabled\":\"true\",\"path\":\"order.poLine.selector\",\"value\":\"\",\"subfields\":[]},{\"name\":\"requester\",\"enabled\":\"true\",\"path\":\"order.poLine.requester\",\"value\":\"\",\"subfields\":[]},{\"name\":\"cancellationRestriction\",\"enabled\":\"true\",\"path\":\"order.poLine.cancellationRestriction\",\"value\":\"\\\"true\\\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"rush\",\"enabled\":\"true\",\"path\":\"order.poLine.rush\",\"value\":\"\\\"true\\\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"checkinItems\",\"enabled\":\"true\",\"path\":\"order.poLine.checkinItems\",\"value\":\"\\\"true\\\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"cancellationDescription\",\"enabled\":\"true\",\"path\":\"order.poLine.cancellationDescription\",\"value\":\"\",\"subfields\":[]},{\"name\":\"poLineDescription\",\"enabled\":\"true\",\"path\":\"order.poLine.poLineDescription\",\"value\":\"\",\"subfields\":[]},{\"name\":\"vendorDetail\",\"enabled\":\"true\",\"path\":\"order.poLine.vendorDetail.referenceNumbers[]\",\"value\":\"\",\"subfields\":[{\"order\":0,\"path\":\"order.poLine.vendorDetail.referenceNumbers[]\",\"fields\":[{\"name\":\"refNumber\",\"enabled\":\"true\",\"path\":\"order.poLine.vendorDetail.referenceNumbers[].refNumber\",\"value\":\"\",\"subfields\":[]},{\"name\":\"refNumberType\",\"enabled\":\"true\",\"path\":\"order.poLine.vendorDetail.referenceNumbers[].refNumberType\",\"value\":\"\\\"Vendor internal number\\\"\",\"subfields\":[]}]}]},{\"name\":\"accountNo\",\"enabled\":\"true\",\"path\":\"order.poLine.accountNo\",\"value\":\"\\\"1234\\\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"instructions\",\"enabled\":\"true\",\"path\":\"order.poLine.vendorDetail.instructions\",\"value\":\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"listUnitPrice\",\"enabled\":\"true\",\"path\":\"order.poLine.cost.listUnitPrice\",\"subfields\":[]},{\"name\":\"quantityPhysical\",\"enabled\":\"true\",\"path\":\"order.poLine.cost.quantityPhysical\",\"value\":\"\\\"2\\\"\",\"subfields\":[]},{\"name\":\"additionalCost\",\"enabled\":\"true\",\"path\":\"order.poLine.cost.additionalCost\",\"value\":\"\",\"subfields\":[]},{\"name\":\"currency\",\"enabled\":\"true\",\"path\":\"order.poLine.cost.currency\",\"value\":\"\\\"UAH\\\"\",\"subfields\":[]},{\"name\":\"useExchangeRate\",\"enabled\":\"true\",\"path\":\"order.poLine.useExchangeRate\",\"booleanFieldAction\":\"ALL_FALSE\",\"subfields\":[]},{\"name\":\"exchangeRate\",\"enabled\":\"true\",\"path\":\"order.poLine.cost.exchangeRate\",\"value\":\"\",\"subfields\":[]},{\"name\":\"electronicUnitPrice\",\"enabled\":\"true\",\"path\":\"order.poLine.cost.electronicUnitPrice\",\"value\":\"\",\"subfields\":[]},{\"name\":\"quantityElectronic\",\"enabled\":\"true\",\"path\":\"order.poLine.cost.quantityElectronic\",\"value\":\"\",\"subfields\":[]},{\"name\":\"discount\",\"enabled\":\"true\",\"path\":\"order.poLine.cost.discount\",\"value\":\"\",\"subfields\":[]},{\"name\":\"discountType\",\"enabled\":\"true\",\"path\":\"order.poLine.cost.discountType\",\"value\":\"amount\",\"subfields\":[]},{\"name\":\"fundDistribution\",\"enabled\":\"true\",\"path\":\"order.poLine.fundDistribution[]\",\"value\":\"\",\"subfields\":[{\"order\":0,\"path\":\"order.poLine.fundDistribution[]\",\"fields\":[{\"name\":\"fundId\",\"enabled\":\"true\",\"path\":\"order.poLine.fundDistribution[].fundId\",\"value\":\"\\\"Asian History\\\"\",\"subfields\":[],\"acceptedValues\":{\"bbd4a5e1-c9f3-44b9-bfdf-d184e04f0ba0\":\"State-MonoSeries\",\"4428a37c-8bae-4f0d-865d-970d83d5ad55\":\"University Allocation\",\"6506b79b-7702-48b2-9774-a1c538fdd34e\":\"Gifts (Non-recurring)\",\"1b6d3338-186e-4e35-9e75-1b886b0da53e\":\"Grants\",\"a89eccf0-57a6-495e-898d-32b9b2210f2f\":\"History Misc\",\"69640328-788e-43fc-9c3c-af39e243f3b7\":\"Oceania History\",\"e6d7e91a-4dbc-4a70-9b38-e000d2fbdc79\":\"Latin American History\",\"d6f7c1ba-a237-465e-94ed-f37e91bc64bd\":\"Exchanges\",\"55f48dc6-efa7-4cfe-bc7c-4786efe493e3\":\"Asian History\",\"67cd0046-e4f1-4e4f-9024-adf0b0039d09\":\"Can/LatAm History\",\"cf23adf0-61ba-4887-bf82-956c4aae2260\":\"FY Sweep Fund\",\"68872d8a-bf16-420b-829f-206da38f6c10\":\"Canadian History\",\"e9f9bc2f-bad5-4613-9d6c-f55efa5805e7\":\"One-time Gifts\",\"f31a36de-fcf8-44f9-87ef-a55d06ad21ae\":\"Slavic & Eastern European History\",\"65032151-39a5-4cef-8810-5350eb316300\":\"US History\",\"1714f71f-b845-444b-a79e-a577487a6f7d\":\"Endowments\",\"e54b1f4d-7d05-4b1a-9368-3c36b75d8ac6\":\"State-Subscriptions\",\"e9285a1c-1dfc-4380-868c-e74073003f43\":\"European History\",\"30fcc8e7-a019-43f4-b642-2edc389f4501\":\"Middle Eastern History\",\"fb7b70f1-b898-4924-a991-0e4b6312bb5f\":\"History\",\"7fbd5d84-62d1-44c6-9c45-6cb173998bbd\":\"African History\"}},{\"name\":\"expenseClassId\",\"enabled\":\"true\",\"path\":\"order.poLine.fundDistribution[].expenseClassId\",\"value\":\"\\\"Electronic\\\"\",\"subfields\":[],\"acceptedValues\":{\"1bcc3247-99bf-4dca-9b0f-7bc51a2998c2\":\"Electronic\",\"5b5ebe3a-cf8b-4f16-a880-46873ef21388\":\"Print\"}},{\"name\":\"value\",\"enabled\":\"true\",\"path\":\"order.poLine.fundDistribution[].value\",\"value\":\"\\\"2\\\"\",\"subfields\":[]},{\"name\":\"distributionType\",\"enabled\":\"true\",\"path\":\"order.poLine.fundDistribution[].distributionType\",\"value\":\"amount\",\"subfields\":[]}]}]},{\"name\":\"locations\",\"enabled\":\"true\",\"path\":\"order.poLine.locations[]\",\"value\":\"\",\"subfields\":[{\"order\":0,\"path\":\"order.poLine.locations[]\",\"fields\":[{\"name\":\"locationId\",\"enabled\":\"true\",\"path\":\"order.poLine.locations[].locationId\",\"value\":\"\\\"Main Library (KU/CC/DI/M)\\\"\",\"subfields\":[],\"acceptedValues\":{\"184aae84-a5bf-4c6a-85ba-4a7c73026cd5\":\"Online (E)\",\"fcd64ce1-6995-48f0-840e-89ffa2288371\":\"Main Library (KU/CC/DI/M)\",\"758258bc-ecc1-41b8-abca-f7b610822ffd\":\"ORWIG ETHNO CD (KU/CC/DI/O)\",\"f34d27c6-a8eb-461b-acd6-5dea81771e70\":\"SECOND FLOOR (KU/CC/DI/2)\",\"53cf956f-c1df-410b-8bea-27f712cca7c0\":\"Annex (KU/CC/DI/A)\",\"b241764c-1466-4e1d-a028-1a3684a5da87\":\"Popular Reading Collection (KU/CC/DI/P)\"}},{\"name\":\"quantityPhysical\",\"enabled\":\"true\",\"path\":\"order.poLine.locations[].quantityPhysical\",\"value\":\"\\\"2\\\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"quantityElectronic\",\"enabled\":\"true\",\"path\":\"order.poLine.locations[].quantityElectronic\",\"value\":\"\\\"2\\\"\",\"subfields\":[]}]}]},{\"name\":\"materialSupplier\",\"enabled\":\"true\",\"path\":\"order.poLine.physical.materialSupplier\",\"value\":\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"receiptDue\",\"enabled\":\"true\",\"path\":\"order.poLine.physical.receiptDue\",\"value\":\"###TODAY###\",\"subfields\":[]},{\"name\":\"expectedReceiptDate\",\"enabled\":\"true\",\"path\":\"order.poLine.physical.expectedReceiptDate\",\"value\":\"\",\"subfields\":[]},{\"name\":\"createInventory\",\"enabled\":\"true\",\"path\":\"order.poLine.physical.createInventory\",\"value\":\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"materialType\",\"enabled\":\"true\",\"path\":\"order.poLine.physical.materialType\",\"value\":\"\",\"subfields\":[],\"acceptedValues\":{\"1a54b431-2e4f-452d-9cae-9cee66c9a892\":\"book\",\"d9acad2f-2aac-4b48-9097-e6ab85906b25\":\"text\",\"5ee11d91-f7e8-481d-b079-65d708582ccc\":\"dvd\",\"615b8413-82d5-4203-aa6e-e37984cb5ac3\":\"electronic resource\",\"dd0bf600-dbd9-44ab-9ff2-e2a61a6539f1\":\"sound recording\",\"30b3e36a-d3b2-415e-98c2-47fbdf878862\":\"video recording\",\"fd6c6515-d470-4561-9c32-3e3290d4ca98\":\"microform\",\"71fbd940-1027-40a6-8a48-49b44d795e46\":\"unspecified\"}},{\"name\":\"volumes\",\"enabled\":\"true\",\"path\":\"order.poLine.physical.volumes[]\",\"value\":\"\",\"subfields\":[]},{\"name\":\"accessProvider\",\"enabled\":\"true\",\"path\":\"order.poLine.eresource.accessProvider\",\"value\":\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"activationStatus\",\"enabled\":\"true\",\"path\":\"order.poLine.eresource.activationStatus\",\"booleanFieldAction\":\"ALL_FALSE\",\"subfields\":[]},{\"name\":\"activationDue\",\"enabled\":\"true\",\"path\":\"order.poLine.eresource.activationDue\",\"value\":\"###TODAY###\",\"subfields\":[]},{\"name\":\"createInventory\",\"enabled\":\"true\",\"path\":\"order.poLine.eresource.createInventory\",\"value\":\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"materialType\",\"enabled\":\"true\",\"path\":\"order.poLine.eresource.materialType\",\"value\":\"\\\"book\\\"\",\"subfields\":[],\"acceptedValues\":{\"1a54b431-2e4f-452d-9cae-9cee66c9a892\":\"book\",\"d9acad2f-2aac-4b48-9097-e6ab85906b25\":\"text\",\"5ee11d91-f7e8-481d-b079-65d708582ccc\":\"dvd\",\"615b8413-82d5-4203-aa6e-e37984cb5ac3\":\"electronic resource\",\"dd0bf600-dbd9-44ab-9ff2-e2a61a6539f1\":\"sound recording\",\"30b3e36a-d3b2-415e-98c2-47fbdf878862\":\"video recording\",\"fd6c6515-d470-4561-9c32-3e3290d4ca98\":\"microform\",\"71fbd940-1027-40a6-8a48-49b44d795e46\":\"unspecified\"}},{\"name\":\"trial\",\"enabled\":\"true\",\"path\":\"order.poLine.eresource.trial\",\"booleanFieldAction\":\"ALL_FALSE\",\"subfields\":[]},{\"name\":\"expectedActivation\",\"enabled\":\"true\",\"path\":\"order.poLine.eresource.expectedActivation\",\"value\":\"\",\"subfields\":[]},{\"name\":\"userLimit\",\"enabled\":\"true\",\"path\":\"order.poLine.eresource.userLimit\",\"value\":\"\",\"subfields\":[]},{\"name\":\"resourceUrl\",\"enabled\":\"true\",\"path\":\"order.poLine.eresource.resourceUrl\",\"value\":\"\",\"subfields\":[]}],\"marcMappingDetails\":[]},\"hidden\":false,\"metadata\":{\"createdDate\":\"2022-11-25T11:27:27.194+00:00\",\"createdByUserId\":\"7b54329f-4ed1-5f7a-9fb1-a4b9c0d61522\",\"updatedDate\":\"2022-11-25T11:27:27.194+00:00\",\"updatedByUserId\":\"7b54329f-4ed1-5f7a-9fb1-a4b9c0d61522\"}}]}";

  //private static final String ORDER_JOB_PROFILE_LITE = "{\"id\":\"244f2c39-ad7a-4046-8a51-2fdd46d3572f\",\"name\":\"Testing Orders+OrderLines\",\"description\":\"\",\"incomingRecordType\":\"MARC_BIBLIOGRAPHIC\",\"existingRecordType\":\"ORDER\",\"deleted\":false,\"userInfo\":{\"firstName\":\"DIKU\",\"lastName\":\"ADMINISTRATOR\",\"userName\":\"diku_admin\"},\"marcFieldProtectionSettings\":[],\"parentProfiles\":[],\"childProfiles\":[],\"mappingDetails\":{\"name\":\"order\",\"recordType\":\"ORDER\",\"mappingFields\":[{\"name\":\"poStatus\",\"enabled\":\"true\",\"path\":\"order.po.poStatus\",\"value\":\"\\\"Pending\\\"\",\"subfields\":[]},{\"name\":\"approved\",\"enabled\":\"true\",\"path\":\"order.po.approved\",\"booleanFieldAction\":\"ALL_TRUE\",\"subfields\":[]},{\"name\":\"poLinesLimit\",\"enabled\":\"false\",\"path\":\"order.po.poLinesLimit\",\"subfields\":[]},{\"name\":\"overridePoLinesLimit\",\"enabled\":\"true\",\"path\":\"order.po.overridePoLinesLimit\",\"subfields\":[]},{\"name\":\"prefix\",\"enabled\":\"true\",\"path\":\"order.po.poNumberPrefix\",\"value\":\"\\\"pref\\\"\",\"subfields\":[],\"acceptedValues\":{\"db9f5d17-0ca3-4d14-ae49-16b63c8fc083\":\"pref\"}},{\"name\":\"poNumber\",\"enabled\":\"true\",\"path\":\"order.po.poNumber\",\"value\":\"\",\"subfields\":[]},{\"name\":\"suffix\",\"enabled\":\"true\",\"path\":\"order.po.poNumberSuffix\",\"value\":\"\\\"suf\\\"\",\"subfields\":[],\"acceptedValues\":{\"0c966bd2-0ca6-43a2-9388-3a4403f19e6f\":\"suf\"}},{\"name\":\"vendor\",\"enabled\":\"true\",\"path\":\"order.po.vendor\",\"value\":\"\\\"11fb627a-cdf1-11e8-a8d5-f2801f1b9fd1\\\"\",\"subfields\":[]},{\"name\":\"orderType\",\"enabled\":\"true\",\"path\":\"order.po.orderType\",\"value\":\"\\\"One-time\\\"\",\"subfields\":[]},{\"name\":\"acqUnitIds\",\"enabled\":\"true\",\"path\":\"order.po.acqUnitIds[]\",\"value\":\"\\\"main\\\"\",\"subfields\":[],\"acceptedValues\":{\"0ebb1f7d-983f-3026-8a4c-5318e0ebc041\":\"main\"}},{\"name\":\"assignedTo\",\"enabled\":\"true\",\"path\":\"order.po.assignedTo\",\"value\":\"\",\"subfields\":[]},{\"name\":\"billTo\",\"enabled\":\"true\",\"path\":\"order.po.billTo\",\"value\":\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"billToAddress\",\"enabled\":\"false\",\"path\":\"order.po.billToAddress\",\"value\":\"\",\"subfields\":[]},{\"name\":\"shipTo\",\"enabled\":\"true\",\"path\":\"order.po.shipTo\",\"value\":\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"shipToAddress\",\"enabled\":\"false\",\"path\":\"order.po.shipToAddress\",\"value\":\"\",\"subfields\":[]},{\"name\":\"manualPo\",\"enabled\":\"true\",\"path\":\"order.po.manualPo\",\"booleanFieldAction\":\"ALL_TRUE\",\"subfields\":[]},{\"name\":\"reEncumber\",\"enabled\":\"true\",\"path\":\"order.po.reEncumber\",\"value\":\"\\\"true\\\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"notes\",\"enabled\":\"true\",\"path\":\"order.po.notes[]\",\"value\":\"\",\"subfields\":[{\"order\":0,\"path\":\"order.po.notes[]\",\"fields\":[{\"name\":\"notes\",\"enabled\":\"true\",\"path\":\"order.po.notes[]\",\"value\":\"\\\"TestingNote\\\"\",\"subfields\":[]}]}]},{\"name\":\"title\",\"enabled\":\"true\",\"path\":\"order.poLine.title.title\",\"value\":\"\\\"TestingTitle\\\"\",\"subfields\":[]},{\"name\":\"receivingNote\",\"enabled\":\"true\",\"path\":\"order.poLine.title.receivingNote\",\"value\":\"\\\"TestingReceivingNote\\\"\",\"subfields\":[]},{\"name\":\"isAcknowledged\",\"enabled\":\"true\",\"path\":\"order.poLine.title.isAcknowledged\",\"value\":\"\\\"true\\\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"subscriptionFrom\",\"enabled\":\"true\",\"path\":\"order.poLine.details.subscriptionFrom\",\"value\":\"###TODAY###\",\"subfields\":[]},{\"name\":\"subscriptionTo\",\"enabled\":\"true\",\"path\":\"order.poLine.details.subscriptionTo\",\"value\":\"###TODAY###\",\"subfields\":[]},{\"name\":\"subscriptionInterval\",\"enabled\":\"true\",\"path\":\"order.poLine.details.subscriptionInterval\",\"value\":\"\\\"1\\\"\",\"subfields\":[]},{\"name\":\"publicationDate\",\"enabled\":\"true\",\"path\":\"order.poLine.publicationDate\",\"value\":\"\",\"subfields\":[]},{\"name\":\"publisher\",\"enabled\":\"true\",\"path\":\"order.poLine.publisher\",\"value\":\"\",\"subfields\":[]},{\"name\":\"edition\",\"enabled\":\"true\",\"path\":\"order.poLine.edition\",\"value\":\"\",\"subfields\":[]},{\"name\":\"contributors\",\"enabled\":\"true\",\"path\":\"order.poLine.contributors[]\",\"value\":\"\",\"subfields\":[{\"order\":0,\"path\":\"order.poLine.contributors[]\",\"fields\":[{\"name\":\"contributor\",\"enabled\":\"true\",\"path\":\"order.poLine.contributors[].contributor\",\"value\":\"\\\"Test Contributor\\\"\",\"subfields\":[]},{\"name\":\"contributorNameTypeId\",\"enabled\":\"true\",\"path\":\"order.poLine.contributors[].contributorNameTypeId\",\"value\":\"\\\"Personal name\\\"\",\"subfields\":[]}]}]},{\"name\":\"productIds\",\"enabled\":\"true\",\"path\":\"order.poLine.details.productIds[]\",\"value\":\"\",\"subfields\":[{\"order\":0,\"path\":\"order.poLine.details.productIds[]\",\"fields\":[{\"name\":\"productId\",\"enabled\":\"true\",\"path\":\"order.poLine.details.productIds[].productId\",\"value\":\"\",\"subfields\":[]},{\"name\":\"qualifier\",\"enabled\":\"true\",\"path\":\"order.poLine.details.productIds[].qualifier\",\"value\":\"\",\"subfields\":[]},{\"name\":\"productIdType\",\"enabled\":\"true\",\"path\":\"order.poLine.details.productIds[].productIdType\",\"value\":\"\\\"DOI\\\"\",\"subfields\":[],\"acceptedValues\":{\"1795ea23-6856-48a5-a772-f356e16a8a6c\":\"UPC\",\"b3ea81fb-3324-4c64-9efc-7c0c93d5943c\":\"Invalid UPC\",\"4f07ea37-6c7f-4836-add2-14249e628ed1\":\"Invalid ISMN\",\"c858e4f2-2b6b-4385-842b-60732ee14abb\":\"LCCN\",\"b5d8cdc4-9441-487c-90cf-0c7ec97728eb\":\"Publisher or distributor number\",\"fc4e3f2a-887a-46e5-8057-aeeb271a4e56\":\"Cancelled system control number\",\"351ebc1c-3aae-4825-8765-c6d50dbf011f\":\"GPO item number\",\"913300b2-03ed-469a-8179-c1092c991227\":\"ISSN\",\"5d164f4b-0b15-4e42-ae75-cfcf85318ad9\":\"Control number\",\"216b156b-215e-4839-a53e-ade35cb5702a\":\"Handle\",\"37b65e79-0392-450d-adc6-e2a1f47de452\":\"Report number\",\"439bfbae-75bc-4f74-9fc7-b2a2d47ce3ef\":\"OCLC\",\"fcca2643-406a-482a-b760-7a7f8aec640e\":\"Invalid ISBN\",\"593b78cb-32f3-44d1-ba8c-63fd5e6989e6\":\"CODEN\",\"39554f54-d0bb-4f0a-89a4-e422f6136316\":\"DOI\",\"eb7b2717-f149-4fec-81a3-deefb8f5ee6b\":\"URN\",\"5130aed5-1095-4fb6-8f6f-caa3d6cc7aae\":\"Local identifier\",\"27fd35a6-b8f6-41f2-aa0e-9c663ceb250c\":\"Invalid ISSN\",\"650ef996-35e3-48ec-bf3a-a0d078a0ca37\":\"UkMac\",\"3187432f-9434-40a8-8782-35a111a1491e\":\"BNB\",\"3fbacad6-0240-4823-bce8-bb122cfdf229\":\"StEdNL\",\"5069054d-bc3a-4212-a4e8-e2013a02386f\":\"Cancelled GPO item number\",\"5860f255-a27f-4916-a830-262aa900a6b9\":\"Linking ISSN\",\"2e8b3b6c-0e7d-4e48-bca2-b0b23b376af5\":\"Other standard identifier\",\"ebfd00b6-61d3-4d87-a6d8-810c941176d5\":\"ISMN\",\"7f907515-a1bf-4513-8a38-92e1a07c539d\":\"ASIN\",\"8261054f-be78-422d-bd51-4ed9f33c3422\":\"ISBN\",\"7e591197-f335-4afb-bc6d-a6d76ca3bace\":\"System control number\",\"8e3dd25e-db82-4b06-8311-90d41998c109\":\"Standard technical report number\"}}]}]},{\"name\":\"internalNote\",\"enabled\":\"true\",\"path\":\"order.poLine.internalNote\",\"value\":\"\\\"TestingInternalNote\\\"\",\"subfields\":[]},{\"name\":\"poLineNumber\",\"enabled\":\"false\",\"path\":\"order.poLine.poLineNumber\",\"value\":\"\",\"subfields\":[]},{\"name\":\"acquisitionMethod\",\"enabled\":\"true\",\"path\":\"order.poLine.acquisitionMethod\",\"value\":\"\\\"Approval Plan\\\"\",\"subfields\":[],\"acceptedValues\":{\"aaa541f3-39d2-4887-ab8f-6ba12d08ca52\":\"Evidence Based Acquisitions (EBA)\",\"86d12634-b848-4968-adf0-5a95ce41c41b\":\"Free\",\"5771a8a4-9323-49ee-9002-1b068d71ff42\":\"Membership\",\"0c9b09c9-b94f-4702-aa63-a7f43617a225\":\"Internal transfer\",\"796596c4-62b5-4b64-a2ce-524c747afaa2\":\"Approval Plan\",\"306489dd-0053-49ee-a068-c316444a8f55\":\"Purchase At Vendor System\",\"0a4163a5-d225-4007-ad90-2fb41b73efab\":\"Gift\",\"041035ad-b2a4-4aa0-b6a5-234b88bf938c\":\"Demand Driven Acquisitions (DDA)\",\"d2420b93-7b93-41b7-8b42-798f64cb6dd2\":\"Depository\",\"da6703b1-81fe-44af-927a-94f24d1ab8ee\":\"Other\",\"df26d81b-9d63-4ff8-bf41-49bf75cfa70e\":\"Purchase\",\"d0d3811c-19f8-4c57-a462-958165cdbbea\":\"Technical\",\"8a33895e-2c69-4a98-ab48-b7ec1fa852d0\":\"Exchange\"}},{\"name\":\"automaticExport\",\"enabled\":\"true\",\"path\":\"order.poLine.automaticExport\",\"booleanFieldAction\":\"ALL_FALSE\",\"subfields\":[]},{\"name\":\"orderFormat\",\"enabled\":\"true\",\"path\":\"order.poLine.orderFormat\",\"value\":\"\\\"P/E Mix\\\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"createdOn\",\"enabled\":\"false\",\"path\":\"order.poLine.createdOn\",\"value\":\"\",\"subfields\":[]},{\"name\":\"receiptDate\",\"enabled\":\"true\",\"path\":\"order.poLine.receiptDate\",\"value\":\"###TODAY###\",\"subfields\":[]},{\"name\":\"receiptStatus\",\"enabled\":\"true\",\"path\":\"order.poLine.receiptStatus\",\"value\":\"\\\"Pending\\\"\",\"subfields\":[]},{\"name\":\"paymentStatus\",\"enabled\":\"true\",\"path\":\"order.poLine.paymentStatus\",\"value\":\"\\\"Pending\\\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"source\",\"enabled\":\"false\",\"path\":\"order.poLine.source\",\"value\":\"\\\"MARC\\\"\",\"subfields\":[]},{\"name\":\"donor\",\"enabled\":\"true\",\"path\":\"order.poLine.donor\",\"value\":\"\",\"subfields\":[]},{\"name\":\"selector\",\"enabled\":\"true\",\"path\":\"order.poLine.selector\",\"value\":\"\",\"subfields\":[]},{\"name\":\"requester\",\"enabled\":\"true\",\"path\":\"order.poLine.requester\",\"value\":\"\",\"subfields\":[]},{\"name\":\"cancellationRestriction\",\"enabled\":\"true\",\"path\":\"order.poLine.cancellationRestriction\",\"value\":\"\\\"true\\\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"rush\",\"enabled\":\"true\",\"path\":\"order.poLine.rush\",\"value\":\"\\\"true\\\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"checkinItems\",\"enabled\":\"true\",\"path\":\"order.poLine.checkinItems\",\"value\":\"\\\"true\\\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"cancellationDescription\",\"enabled\":\"true\",\"path\":\"order.poLine.cancellationDescription\",\"value\":\"\",\"subfields\":[]},{\"name\":\"poLineDescription\",\"enabled\":\"true\",\"path\":\"order.poLine.poLineDescription\",\"value\":\"\",\"subfields\":[]},{\"name\":\"vendorDetail\",\"enabled\":\"true\",\"path\":\"order.poLine.vendorDetail.referenceNumbers[]\",\"value\":\"\",\"subfields\":[{\"order\":0,\"path\":\"order.poLine.vendorDetail.referenceNumbers[]\",\"fields\":[{\"name\":\"refNumber\",\"enabled\":\"true\",\"path\":\"order.poLine.vendorDetail.referenceNumbers[].refNumber\",\"value\":\"\",\"subfields\":[]},{\"name\":\"refNumberType\",\"enabled\":\"true\",\"path\":\"order.poLine.vendorDetail.referenceNumbers[].refNumberType\",\"value\":\"\\\"Vendor internal number\\\"\",\"subfields\":[]}]}]},{\"name\":\"accountNo\",\"enabled\":\"true\",\"path\":\"order.poLine.accountNo\",\"value\":\"\\\"1234\\\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"instructions\",\"enabled\":\"true\",\"path\":\"order.poLine.vendorDetail.instructions\",\"value\":\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"listUnitPrice\",\"enabled\":\"true\",\"path\":\"order.poLine.cost.listUnitPrice\",\"subfields\":[]},{\"name\":\"quantityPhysical\",\"enabled\":\"true\",\"path\":\"order.poLine.cost.quantityPhysical\",\"value\":\"\\\"2\\\"\",\"subfields\":[]},{\"name\":\"additionalCost\",\"enabled\":\"true\",\"path\":\"order.poLine.cost.additionalCost\",\"value\":\"\",\"subfields\":[]},{\"name\":\"currency\",\"enabled\":\"true\",\"path\":\"order.poLine.cost.currency\",\"value\":\"\\\"UAH\\\"\",\"subfields\":[]},{\"name\":\"useExchangeRate\",\"enabled\":\"true\",\"path\":\"order.poLine.useExchangeRate\",\"booleanFieldAction\":\"ALL_FALSE\",\"subfields\":[]},{\"name\":\"exchangeRate\",\"enabled\":\"true\",\"path\":\"order.poLine.cost.exchangeRate\",\"value\":\"\",\"subfields\":[]},{\"name\":\"electronicUnitPrice\",\"enabled\":\"true\",\"path\":\"order.poLine.cost.electronicUnitPrice\",\"value\":\"\",\"subfields\":[]},{\"name\":\"quantityElectronic\",\"enabled\":\"true\",\"path\":\"order.poLine.cost.quantityElectronic\",\"value\":\"\",\"subfields\":[]},{\"name\":\"discount\",\"enabled\":\"true\",\"path\":\"order.poLine.cost.discount\",\"value\":\"\",\"subfields\":[]},{\"name\":\"discountType\",\"enabled\":\"true\",\"path\":\"order.poLine.cost.discountType\",\"value\":\"amount\",\"subfields\":[]},{\"name\":\"fundDistribution\",\"enabled\":\"true\",\"path\":\"order.poLine.fundDistribution[]\",\"value\":\"\",  \"repeatableFieldAction\": \"EXTEND_EXISTING\",  \"subfields\":[{\"order\":0,\"path\":\"order.poLine.fundDistribution[]\",\"fields\":[{\"name\":\"fundId\",\"enabled\":\"true\",\"path\":\"order.poLine.fundDistribution[].fundId\",\"value\":\"\\\"Asian History\\\"\",\"subfields\":[],\"acceptedValues\":{\"bbd4a5e1-c9f3-44b9-bfdf-d184e04f0ba0\":\"State-MonoSeries\",\"4428a37c-8bae-4f0d-865d-970d83d5ad55\":\"University Allocation\",\"6506b79b-7702-48b2-9774-a1c538fdd34e\":\"Gifts (Non-recurring)\",\"1b6d3338-186e-4e35-9e75-1b886b0da53e\":\"Grants\",\"a89eccf0-57a6-495e-898d-32b9b2210f2f\":\"History Misc\",\"69640328-788e-43fc-9c3c-af39e243f3b7\":\"Oceania History\",\"e6d7e91a-4dbc-4a70-9b38-e000d2fbdc79\":\"Latin American History\",\"d6f7c1ba-a237-465e-94ed-f37e91bc64bd\":\"Exchanges\",\"55f48dc6-efa7-4cfe-bc7c-4786efe493e3\":\"Asian History\",\"67cd0046-e4f1-4e4f-9024-adf0b0039d09\":\"Can/LatAm History\",\"cf23adf0-61ba-4887-bf82-956c4aae2260\":\"FY Sweep Fund\",\"68872d8a-bf16-420b-829f-206da38f6c10\":\"Canadian History\",\"e9f9bc2f-bad5-4613-9d6c-f55efa5805e7\":\"One-time Gifts\",\"f31a36de-fcf8-44f9-87ef-a55d06ad21ae\":\"Slavic & Eastern European History\",\"65032151-39a5-4cef-8810-5350eb316300\":\"US History\",\"1714f71f-b845-444b-a79e-a577487a6f7d\":\"Endowments\",\"e54b1f4d-7d05-4b1a-9368-3c36b75d8ac6\":\"State-Subscriptions\",\"e9285a1c-1dfc-4380-868c-e74073003f43\":\"European History\",\"30fcc8e7-a019-43f4-b642-2edc389f4501\":\"Middle Eastern History\",\"fb7b70f1-b898-4924-a991-0e4b6312bb5f\":\"History\",\"7fbd5d84-62d1-44c6-9c45-6cb173998bbd\":\"African History\"}},{\"name\":\"expenseClassId\",\"enabled\":\"true\",\"path\":\"order.poLine.fundDistribution[].expenseClassId\",\"value\":\"\\\"Electronic\\\"\",\"subfields\":[],\"acceptedValues\":{\"1bcc3247-99bf-4dca-9b0f-7bc51a2998c2\":\"Electronic\",\"5b5ebe3a-cf8b-4f16-a880-46873ef21388\":\"Print\"}},{\"name\":\"value\",\"enabled\":\"true\",\"path\":\"order.poLine.fundDistribution[].value\",\"value\":\"\\\"2\\\"\",\"subfields\":[]},{\"name\":\"distributionType\",\"enabled\":\"true\",\"path\":\"order.poLine.fundDistribution[].distributionType\",\"value\":\"amount\",\"subfields\":[]}]}]},{\"name\":\"locations\",\"enabled\":\"true\",\"path\":\"order.poLine.locations[]\",\"value\":\"\",  \"repeatableFieldAction\": \"EXTEND_EXISTING\",   \"subfields\":[{\"order\":0,\"path\":\"order.poLine.locations[]\",\"fields\":[{\"name\":\"locationId\",\"enabled\":\"true\",\"path\":\"order.poLine.locations[].locationId\",\"value\":\"\\\"Main Library (KU/CC/DI/M)\\\"\",\"subfields\":[],\"acceptedValues\":{\"184aae84-a5bf-4c6a-85ba-4a7c73026cd5\":\"Online (E)\",\"fcd64ce1-6995-48f0-840e-89ffa2288371\":\"Main Library (KU/CC/DI/M)\",\"758258bc-ecc1-41b8-abca-f7b610822ffd\":\"ORWIG ETHNO CD (KU/CC/DI/O)\",\"f34d27c6-a8eb-461b-acd6-5dea81771e70\":\"SECOND FLOOR (KU/CC/DI/2)\",\"53cf956f-c1df-410b-8bea-27f712cca7c0\":\"Annex (KU/CC/DI/A)\",\"b241764c-1466-4e1d-a028-1a3684a5da87\":\"Popular Reading Collection (KU/CC/DI/P)\"}},{\"name\":\"quantityPhysical\",\"enabled\":\"true\",\"path\":\"order.poLine.locations[].quantityPhysical\",\"value\":\"\\\"2\\\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"quantityElectronic\",\"enabled\":\"true\",\"path\":\"order.poLine.locations[].quantityElectronic\",\"value\":\"\\\"2\\\"\",\"subfields\":[]}]}]},{\"name\":\"materialSupplier\",\"enabled\":\"true\",\"path\":\"order.poLine.physical.materialSupplier\",\"value\":\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"receiptDue\",\"enabled\":\"true\",\"path\":\"order.poLine.physical.receiptDue\",\"value\":\"###TODAY###\",\"subfields\":[]},{\"name\":\"expectedReceiptDate\",\"enabled\":\"true\",\"path\":\"order.poLine.physical.expectedReceiptDate\",\"value\":\"\",\"subfields\":[]},{\"name\":\"createInventory\",\"enabled\":\"true\",\"path\":\"order.poLine.physical.createInventory\",\"value\":\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"materialType\",\"enabled\":\"true\",\"path\":\"order.poLine.physical.materialType\",\"value\":\"\",\"subfields\":[],\"acceptedValues\":{\"1a54b431-2e4f-452d-9cae-9cee66c9a892\":\"book\",\"d9acad2f-2aac-4b48-9097-e6ab85906b25\":\"text\",\"5ee11d91-f7e8-481d-b079-65d708582ccc\":\"dvd\",\"615b8413-82d5-4203-aa6e-e37984cb5ac3\":\"electronic resource\",\"dd0bf600-dbd9-44ab-9ff2-e2a61a6539f1\":\"sound recording\",\"30b3e36a-d3b2-415e-98c2-47fbdf878862\":\"video recording\",\"fd6c6515-d470-4561-9c32-3e3290d4ca98\":\"microform\",\"71fbd940-1027-40a6-8a48-49b44d795e46\":\"unspecified\"}},{\"name\":\"volumes\",\"enabled\":\"true\",\"path\":\"order.poLine.physical.volumes[]\",\"value\":\"\",\"subfields\":[]},{\"name\":\"accessProvider\",\"enabled\":\"true\",\"path\":\"order.poLine.eresource.accessProvider\",\"value\":\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"activationStatus\",\"enabled\":\"true\",\"path\":\"order.poLine.eresource.activationStatus\",\"booleanFieldAction\":\"ALL_FALSE\",\"subfields\":[]},{\"name\":\"activationDue\",\"enabled\":\"true\",\"path\":\"order.poLine.eresource.activationDue\",\"value\":\"###TODAY###\",\"subfields\":[]},{\"name\":\"createInventory\",\"enabled\":\"true\",\"path\":\"order.poLine.eresource.createInventory\",\"value\":\"\",\"subfields\":[],\"acceptedValues\":{}},{\"name\":\"materialType\",\"enabled\":\"true\",\"path\":\"order.poLine.eresource.materialType\",\"value\":\"\\\"book\\\"\",\"subfields\":[],\"acceptedValues\":{\"1a54b431-2e4f-452d-9cae-9cee66c9a892\":\"book\",\"d9acad2f-2aac-4b48-9097-e6ab85906b25\":\"text\",\"5ee11d91-f7e8-481d-b079-65d708582ccc\":\"dvd\",\"615b8413-82d5-4203-aa6e-e37984cb5ac3\":\"electronic resource\",\"dd0bf600-dbd9-44ab-9ff2-e2a61a6539f1\":\"sound recording\",\"30b3e36a-d3b2-415e-98c2-47fbdf878862\":\"video recording\",\"fd6c6515-d470-4561-9c32-3e3290d4ca98\":\"microform\",\"71fbd940-1027-40a6-8a48-49b44d795e46\":\"unspecified\"}},{\"name\":\"trial\",\"enabled\":\"true\",\"path\":\"order.poLine.eresource.trial\",\"booleanFieldAction\":\"ALL_FALSE\",\"subfields\":[]},{\"name\":\"expectedActivation\",\"enabled\":\"true\",\"path\":\"order.poLine.eresource.expectedActivation\",\"value\":\"\",\"subfields\":[]},{\"name\":\"userLimit\",\"enabled\":\"true\",\"path\":\"order.poLine.eresource.userLimit\",\"value\":\"\",\"subfields\":[]},{\"name\":\"resourceUrl\",\"enabled\":\"true\",\"path\":\"order.poLine.eresource.resourceUrl\",\"value\":\"\",\"subfields\":[]}],\"marcMappingDetails\":[]},\"hidden\":false,\"metadata\":{\"createdDate\":\"2022-11-25T11:27:27.194+00:00\",\"createdByUserId\":\"7b54329f-4ed1-5f7a-9fb1-a4b9c0d61522\",\"updatedDate\":\"2022-11-25T11:27:27.194+00:00\",\"updatedByUserId\":\"7b54329f-4ed1-5f7a-9fb1-a4b9c0d61522\"}}";
  private final Storage storage;
  private final MappingMetadataCache mappingMetadataCache;
  private final IdStorageService idStorageService;
  private OrderEventService orderEventService;

  public CreateHoldingEventHandler(Storage storage, MappingMetadataCache mappingMetadataCache, IdStorageService idStorageService,
                                   OrderEventService orderEventService) {
    this.orderEventService = orderEventService;
    this.storage = storage;
    this.mappingMetadataCache = mappingMetadataCache;
    this.idStorageService = idStorageService;
  }

  @Override
  public CompletableFuture<DataImportEventPayload> handle(DataImportEventPayload dataImportEventPayload) {
    CompletableFuture<DataImportEventPayload> future = new CompletableFuture<>();
    try {
      dataImportEventPayload.setEventType(DI_INVENTORY_HOLDING_CREATED.value());

      HashMap<String, String> payloadContext = dataImportEventPayload.getContext();
      if (payloadContext == null || payloadContext.isEmpty()
        || StringUtils.isEmpty(payloadContext.get(MARC_BIBLIOGRAPHIC.value()))) {
        LOGGER.warn("Can`t create Holding entity for context: {}", payloadContext);
        throw new EventProcessingException(CONTEXT_EMPTY_ERROR_MESSAGE);
      }
      if (dataImportEventPayload.getCurrentNode().getChildSnapshotWrappers().isEmpty()) {
        LOGGER.error(ACTION_HAS_NO_MAPPING_MSG);
        return CompletableFuture.failedFuture(new EventProcessingException(ACTION_HAS_NO_MAPPING_MSG));
      }

      Context context = constructContext(dataImportEventPayload.getTenant(), dataImportEventPayload.getToken(), dataImportEventPayload.getOkapiUrl());
      String jobExecutionId = dataImportEventPayload.getJobExecutionId();
      String recordId = payloadContext.get(RECORD_ID_HEADER);
      String chunkId = payloadContext.get(CHUNK_ID_HEADER);
      LOGGER.info("Create holding with jobExecutionId: {} , recordId: {} , chunkId: {}", jobExecutionId, recordId, chunkId);

      Future<RecordToEntity> recordToHoldingsFuture = idStorageService.store(recordId, UUID.randomUUID().toString(), dataImportEventPayload.getTenant());
      recordToHoldingsFuture.onSuccess(res -> {
          String holdingsId = res.getEntityId();
          mappingMetadataCache.get(jobExecutionId, context)
            .map(parametersOptional -> parametersOptional.orElseThrow(() ->
              new EventProcessingException(format(MAPPING_METADATA_NOT_FOUND_MSG,
                jobExecutionId, recordId, chunkId))))
            .map(mappingMetadataDto -> {
              try {
                prepareEvent(dataImportEventPayload);
              } catch (JsonProcessingException e) {
                throw new RuntimeException(e);
              }
              MappingParameters mappingParameters = Json.decodeValue(mappingMetadataDto.getMappingParams(), MappingParameters.class);
              MappingManager.map(dataImportEventPayload, new MappingContext().withMappingParameters(mappingParameters));

              JsonObject holdingAsJson = new JsonObject(payloadContext.get(HOLDINGS.value()));
              if (holdingAsJson.getJsonObject(HOLDINGS_PATH_FIELD) != null) {
                holdingAsJson = holdingAsJson.getJsonObject(HOLDINGS_PATH_FIELD);
              }
              holdingAsJson.put("id", holdingsId);
              holdingAsJson.put("sourceId", FOLIO_SOURCE_ID);
              fillInstanceIdIfNeeded(dataImportEventPayload, holdingAsJson);
              checkIfPermanentLocationIdExists(holdingAsJson);
              return Json.decodeValue(payloadContext.get(HOLDINGS.value()), HoldingsRecord.class);
            })
            .compose(holdingToCreate -> addHoldings(holdingToCreate, context))
            .onSuccess(createdHoldings -> {
              LOGGER.info("Created Holding record by jobExecutionId: '{}' and recordId: '{}' and chunkId: '{}'",
                jobExecutionId, recordId, chunkId);
              payloadContext.put(HOLDINGS.value(), Json.encodePrettily(createdHoldings));
              orderEventService.executeOrderLogicIfNeeded(dataImportEventPayload, context);
              future.complete(dataImportEventPayload);
            })
            .onFailure(e -> {
              if (!(e instanceof DuplicateEventException)) {
                LOGGER.error("Error creating inventory Holding record by jobExecutionId: '{}' and recordId: '{}' and chunkId: '{}' ", jobExecutionId,
                  recordId, chunkId, e);
              }
              future.completeExceptionally(e);
            });
        })
        .onFailure(failure -> {
          LOGGER.error("Error creating inventory recordId and holdingsId relationship by jobExecutionId: '{}' and recordId: '{}' and chunkId: '{}' ",
            jobExecutionId, recordId, chunkId, failure);
          future.completeExceptionally(failure);
        });
    } catch (Exception e) {
      LOGGER.error(CREATE_HOLDING_ERROR_MESSAGE, e);
      future.completeExceptionally(e);
    }
    return future;
  }

  @Override
  public boolean isEligible(DataImportEventPayload dataImportEventPayload) {
    if (dataImportEventPayload.getContext().get(MARC_BIBLIOGRAPHIC.value()) != null && dataImportEventPayload.getCurrentNode() != null && ACTION_PROFILE == dataImportEventPayload.getCurrentNode().getContentType()) {
      ActionProfile actionProfile = JsonObject.mapFrom(dataImportEventPayload.getCurrentNode().getContent()).mapTo(ActionProfile.class);
      return actionProfile.getAction() == ActionProfile.Action.CREATE && actionProfile.getFolioRecord() == ActionProfile.FolioRecord.HOLDINGS;
    }
    return false;
  }

  private void prepareEvent(DataImportEventPayload dataImportEventPayload) throws JsonProcessingException {
    dataImportEventPayload.getEventsChain().add(dataImportEventPayload.getEventType());
    dataImportEventPayload.getContext().put(HOLDINGS.value(), new JsonObject().encode());
    dataImportEventPayload.setCurrentNode(dataImportEventPayload.getCurrentNode().getChildSnapshotWrappers().get(0));

    dataImportEventPayload.getContext().remove(HOLDINGS.value());
    dataImportEventPayload.getContext().put("ORDER", new JsonObject().encode());
    MappingProfile improvedMappingProfile = new ObjectMapper().readValue(ORDER_JOB_PROFILE_LITE, MappingProfile.class);
    ProfileSnapshotWrapper mappingProfileWrapper = new ProfileSnapshotWrapper();
    mappingProfileWrapper.setContent(improvedMappingProfile);
    mappingProfileWrapper.setContentType(MAPPING_PROFILE);
    dataImportEventPayload.setCurrentNode(mappingProfileWrapper);
    dataImportEventPayload.setEventType("DI_INVENTORY_ORDER_CREATED");
    dataImportEventPayload.getEventsChain().add(dataImportEventPayload.getEventType());
    dataImportEventPayload.getContext().put("CURRENT_NODE", ORDER_JOB_PROFILE);


  }

  private void fillInstanceIdIfNeeded(DataImportEventPayload dataImportEventPayload, JsonObject holdingAsJson) {
    if (isBlank(holdingAsJson.getString(INSTANCE_ID_FIELD))) {
      String instanceId = null;
      String instanceAsString = dataImportEventPayload.getContext().get(EntityType.INSTANCE.value());

      if (isNotEmpty(instanceAsString)) {
        JsonObject holdingsRecord = new JsonObject(instanceAsString);
        instanceId = holdingsRecord.getString("id");
      }
      if (isBlank(instanceId)) {
        String recordAsString = dataImportEventPayload.getContext().get(EntityType.MARC_BIBLIOGRAPHIC.value());
        Record record = Json.decodeValue(recordAsString, Record.class);
        instanceId = ParsedRecordUtil.getAdditionalSubfieldValue(record.getParsedRecord(), ParsedRecordUtil.AdditionalSubfields.I);
      }
      if (isBlank(instanceId)) {
        throw new EventProcessingException(PAYLOAD_DATA_HAS_NO_INSTANCE_ID_ERROR_MSG);
      }
      fillInstanceId(dataImportEventPayload, holdingAsJson, instanceId);
    }
  }

  private void checkIfPermanentLocationIdExists(JsonObject holdingAsJson) {
    if (isEmpty(holdingAsJson.getString(PERMANENT_LOCATION_ID_FIELD))) {
      throw new EventProcessingException(PERMANENT_LOCATION_ID_ERROR_MESSAGE);
    }
  }

  private void fillInstanceId(DataImportEventPayload dataImportEventPayload, JsonObject holdingAsJson, String instanceId) {
    holdingAsJson.put(INSTANCE_ID_FIELD, instanceId);
    dataImportEventPayload.getContext().put(HOLDINGS.value(), holdingAsJson.encode());
  }

  private Future<HoldingsRecord> addHoldings(HoldingsRecord holdings, Context context) {
    Promise<HoldingsRecord> promise = Promise.promise();
    HoldingsRecordCollection holdingsRecordCollection = storage.getHoldingsRecordCollection(context);
    holdingsRecordCollection.add(holdings,
      success -> promise.complete(success.getResult()),
      failure -> {
        //for now there is a solution via error-message contains. It will be improved via another solution by https://issues.folio.org/browse/RMB-899.
        if (isNotBlank(failure.getReason()) && failure.getReason().contains(UNIQUE_ID_ERROR_MESSAGE)) {
          LOGGER.info("Duplicated event received by InstanceId: {}. Ignoring...", holdings.getId());
          promise.fail(new DuplicateEventException(format("Duplicated event by Holding id: %s", holdings.getId())));
        } else {
          LOGGER.error(format("Error posting Holdings cause %s, status code %s", failure.getReason(), failure.getStatusCode()));
          promise.fail(failure.getReason());
        }
      });
    return promise.future();
  }
}
